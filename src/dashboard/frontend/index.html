<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEM Image Alignment Dashboard</title>
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Colors */
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --primary-light: #dbeafe;
            --secondary: #6366f1;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            
            /* Light Theme */
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.1);
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* Border Radius */
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 300ms ease;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
            --primary-light: #1e3a8a;
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            transition: background-color var(--transition-normal), color var(--transition-normal);
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.2;
        }

        h1 { font-size: 2rem; }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.25rem; }
        h4 { font-size: 1rem; }

        /* Container */
        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        /* Card Component */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: 0 1px 3px var(--shadow);
            padding: var(--spacing-lg);
            transition: all var(--transition-normal);
        }

        .card:hover {
            box-shadow: 0 4px 6px var(--shadow);
        }

        /* Button Component */
        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-ghost:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Form Controls */
        select, input[type="checkbox"] {
            padding: var(--spacing-sm);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all var(--transition-fast);
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }

        label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            box-shadow: 0 1px 3px var(--shadow);
            position: relative;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .header h1 {
            color: var(--text-primary);
        }

        .theme-toggle {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }

        /* Filters Section */
        .filters {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: 0 1px 3px var(--shadow);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .filters-header h3 {
            color: var(--text-primary);
        }

        .filter-status {
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: 500;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .filter-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
        }

        /* Main Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        /* Sessions List */
        .sessions-section {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: 0 1px 3px var(--shadow);
        }

        .sessions-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-height: 300px;
            overflow-y: auto;
        }

        .session-item {
            padding: var(--spacing-md);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--bg-secondary);
        }

        .session-item:hover {
            border-color: var(--primary);
            transform: translateX(2px);
        }

        .session-item.active {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .session-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
        }

        .session-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .session-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .session-stats {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.875rem;
        }

        .session-stat {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        /* Test Details Grid */
        .test-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
            height: 600px;
        }

        .test-cases-section,
        .image-results-section {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: 0 1px 3px var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .section-header {
            margin-bottom: var(--spacing-md);
            flex-shrink: 0;
        }

        .test-cases-container,
        .image-results-container {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        /* Test Cases */
        .test-grid {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .test-item {
            padding: var(--spacing-md);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--bg-secondary);
        }

        .test-item:hover {
            border-color: var(--primary);
            transform: translateX(2px);
        }

        .test-item.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
        }

        .test-name {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .test-status {
            font-size: 0.75rem;
        }

        .test-status.success {
            color: var(--success);
        }

        .test-status.failed {
            color: var(--error);
        }

        .test-metrics {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            gap: var(--spacing-sm);
        }

        /* Image Results */
        .image-container {
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }

        .image-container h4 {
            margin-bottom: var(--spacing-sm);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .image-container img {
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            cursor: zoom-in;
            transition: transform var(--transition-fast);
        }

        .image-container img:hover {
            transform: scale(1.02);
        }

        .metrics-panel {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            font-size: 0.875rem;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-xs) 0;
            border-bottom: 1px solid var(--border);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-secondary);
        }

        .metric-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Performance Summary */
        .performance-section {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: 0 1px 3px var(--shadow);
        }

        .algorithm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-md);
        }

        .algorithm-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            transition: all var(--transition-fast);
        }

        .algorithm-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .algorithm-name {
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin: var(--spacing-sm) 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width var(--transition-normal);
        }

        .algorithm-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            font-size: 0.75rem;
            margin-top: var(--spacing-sm);
        }

        /* Scrollbar Styling */
        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        *::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        *::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: var(--radius-sm);
        }

        *::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* Loading & Empty States */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            cursor: zoom-out;
            backdrop-filter: blur(4px);
        }

        .modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            box-shadow: 0 4px 6px var(--shadow);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: var(--success);
            color: white;
        }

        .toast.error {
            background: var(--error);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .test-details-grid {
                grid-template-columns: 1fr;
                height: auto;
            }

            .test-cases-section,
            .image-results-section {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-md);
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .algorithm-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-md);
            }
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-secondary);
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-sm {
            gap: var(--spacing-sm);
        }

        .gap-md {
            gap: var(--spacing-md);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <button class="btn btn-ghost theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                <span id="themeIcon">🌙</span>
            </button>
            <div class="header-content">
                <h1>SEM Image Alignment Dashboard</h1>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" id="totalTests">-</span>
                    <span class="stat-label">Total Tests</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="successRate">-</span>
                    <span class="stat-label">Success Rate</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="avgTime">-</span>
                    <span class="stat-label">Avg Time (ms)</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="testSessions">-</span>
                    <span class="stat-label">Test Sessions</span>
                </div>
            </div>
        </header>

        <!-- Filters -->
        <section class="filters">
            <div class="filters-header">
                <h3>Filter Results</h3>
                <span class="filter-status" id="filterStatus"></span>
            </div>
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="algorithmFilter">Algorithm</label>
                    <select id="algorithmFilter">
                        <option value="">All Algorithms</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="patchSizeFilter">Patch Size</label>
                    <select id="patchSizeFilter">
                        <option value="">All Sizes</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="transformationFilter">Transformation</label>
                    <select id="transformationFilter">
                        <option value="">All Transformations</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>
                        <input type="checkbox" id="successOnlyFilter">
                        Success Only
                    </label>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-secondary" onclick="clearFilters()">
                    Clear Filters
                </button>
                <button class="btn btn-primary" onclick="refreshData()">
                    Refresh
                </button>
            </div>
        </section>

        <!-- Test Sessions -->
        <section class="sessions-section">
            <h3 class="section-header">Test Sessions</h3>
            <div id="sessionsList" class="sessions-list">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </section>

        <!-- Main Content Grid -->
        <div class="test-details-grid">
            <!-- Test Cases -->
            <section class="test-cases-section">
                <h3 class="section-header">Test Cases</h3>
                <div class="test-cases-container">
                    <div id="testCasesList" class="empty-state">
                        Select a test session to view details
                    </div>
                </div>
            </section>

            <!-- Image Results -->
            <section class="image-results-section">
                <h3 class="section-header">Visual Results</h3>
                <div class="image-results-container" id="imageResults">
                    <div class="empty-state">
                        Select a test case to view visual results
                    </div>
                </div>
            </section>
        </div>

        <!-- Performance Summary -->
        <section class="performance-section">
            <h3 class="section-header">Algorithm Performance Summary</h3>
            <div id="algorithmSummary" class="algorithm-grid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Global state
        let dashboardData = null;
        let filteredData = null;
        let selectedSession = null;
        let selectedTest = null;
        let currentFilters = {
            algorithm: '',
            patchSize: '',
            transformation: '',
            successOnly: false
        };

        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            document.getElementById('themeIcon').textContent = theme === 'light' ? '🌙' : '☀️';
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            loadDashboardData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Store filter values before they change
            const algorithmFilter = document.getElementById('algorithmFilter');
            const patchSizeFilter = document.getElementById('patchSizeFilter');
            const transformationFilter = document.getElementById('transformationFilter');
            const successOnlyFilter = document.getElementById('successOnlyFilter');

            algorithmFilter.addEventListener('change', (e) => {
                currentFilters.algorithm = e.target.value;
                applyFilters();
            });

            patchSizeFilter.addEventListener('change', (e) => {
                currentFilters.patchSize = e.target.value;
                applyFilters();
            });

            transformationFilter.addEventListener('change', (e) => {
                currentFilters.transformation = e.target.value;
                applyFilters();
            });

            successOnlyFilter.addEventListener('change', (e) => {
                currentFilters.successOnly = e.target.checked;
                applyFilters();
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.querySelector('.modal')) {
                    closeModal();
                }
            });
        }

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/data');
                if (!response.ok) throw new Error('Failed to fetch data');
                
                dashboardData = await response.json();
                filteredData = dashboardData;
                updateDashboard();
                loadAlgorithmSummary();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Failed to load dashboard data', 'error');
            }
        }

        async function loadAlgorithmSummary() {
            try {
                const response = await fetch('/api/algorithms/summary');
                if (!response.ok) throw new Error('Failed to fetch algorithm summary');
                
                const summaries = await response.json();
                renderAlgorithmSummary(summaries);
            } catch (error) {
                console.error('Error loading algorithm summary:', error);
            }
        }

        function updateDashboard() {
            if (!filteredData) return;

            // Update global stats
            const totalTests = filteredData.test_sessions.reduce((sum, session) => sum + session.total_tests, 0);
            const totalSuccessful = filteredData.test_sessions.reduce((sum, session) => 
                sum + session.test_results.filter(t => t.performance_metrics.success).length, 0);
            const avgSuccessRate = totalTests > 0 ? (totalSuccessful / totalTests * 100) : 0;
            const avgTime = filteredData.test_sessions.reduce((sum, session) => sum + session.avg_processing_time, 0) / 
                            (filteredData.test_sessions.length || 1);

            document.getElementById('totalTests').textContent = totalTests.toLocaleString();
            document.getElementById('successRate').textContent = avgSuccessRate.toFixed(1) + '%';
            document.getElementById('avgTime').textContent = avgTime.toFixed(1);
            document.getElementById('testSessions').textContent = filteredData.test_sessions.length;

            // Populate filter options from original data
            populateFilterOptions();
            
            // Restore filter values
            document.getElementById('algorithmFilter').value = currentFilters.algorithm;
            document.getElementById('patchSizeFilter').value = currentFilters.patchSize;
            document.getElementById('transformationFilter').value = currentFilters.transformation;
            document.getElementById('successOnlyFilter').checked = currentFilters.successOnly;
            
            // Render sessions
            renderTestSessions();
            updateFilterStatus();
        }

        function populateFilterOptions() {
            if (!dashboardData) return;

            const algorithmSelect = document.getElementById('algorithmFilter');
            const patchSizeSelect = document.getElementById('patchSizeFilter');
            const transformationSelect = document.getElementById('transformationFilter');

            // Clear existing options except the first one
            algorithmSelect.innerHTML = '<option value="">All Algorithms</option>';
            patchSizeSelect.innerHTML = '<option value="">All Sizes</option>';
            transformationSelect.innerHTML = '<option value="">All Transformations</option>';

            // Add options from original data (not filtered data)
            dashboardData.algorithms.forEach(algorithm => {
                const option = document.createElement('option');
                option.value = algorithm;
                option.textContent = algorithm;
                algorithmSelect.appendChild(option);
            });

            dashboardData.patch_sizes.forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                patchSizeSelect.appendChild(option);
            });

            dashboardData.transformations.forEach(transformation => {
                const option = document.createElement('option');
                option.value = transformation;
                option.textContent = transformation.replace(/_/g, ' ');
                transformationSelect.appendChild(option);
            });
        }

        function renderTestSessions() {
            const sessionsList = document.getElementById('sessionsList');
            
            if (!filteredData.test_sessions.length) {
                sessionsList.innerHTML = '<div class="empty-state">No test sessions found</div>';
                return;
            }

            sessionsList.innerHTML = filteredData.test_sessions.map(session => `
                <div class="session-item ${selectedSession?.id === session.id ? 'active' : ''}" 
                     onclick="selectSession('${session.id}')">
                    <div class="session-info">
                        <span class="session-title">${session.name}</span>
                        <span class="session-meta">${new Date(session.created_at).toLocaleDateString()}</span>
                    </div>
                    <div class="session-meta">${session.sem_image_path.split('/').pop()}</div>
                    <div class="session-stats">
                        <span class="session-stat">
                            <span>Tests:</span>
                            <strong>${session.total_tests}</strong>
                        </span>
                        <span class="session-stat">
                            <span>Success:</span>
                            <strong class="${session.success_rate > 70 ? 'text-success' : 'text-error'}">
                                ${session.success_rate.toFixed(1)}%
                            </strong>
                        </span>
                        <span class="session-stat">
                            <span>Avg:</span>
                            <strong>${session.avg_processing_time.toFixed(1)}ms</strong>
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function selectSession(sessionId) {
            selectedSession = filteredData.test_sessions.find(s => s.id === sessionId);
            selectedTest = null;
            renderTestSessions();
            renderTestCases();
            clearImageDisplay();
        }

        function renderTestCases() {
            const testCasesList = document.getElementById('testCasesList');
            
            if (!selectedSession) {
                testCasesList.innerHTML = '<div class="empty-state">Select a test session to view details</div>';
                return;
            }

            if (!selectedSession.test_results.length) {
                testCasesList.innerHTML = '<div class="empty-state">No test cases found in this session</div>';
                return;
            }

            testCasesList.innerHTML = `
                <div class="test-grid">
                    ${selectedSession.test_results.map(test => `
                        <div class="test-item ${selectedTest?.test_id === test.test_id ? 'selected' : ''}"
                             onclick="selectTest('${test.test_id}')">
                            <div class="test-header">
                                <span class="test-name">${test.algorithm_name}</span>
                                <span class="test-status ${test.performance_metrics.success ? 'success' : 'failed'}">
                                    ${test.performance_metrics.success ? '✓' : '✗'}
                                </span>
                            </div>
                            <div class="test-metrics">
                                <span>${test.patch_info.size[0]}×${test.patch_info.size[1]}</span>
                                <span>${test.transformation_applied.noise_parameters}</span>
                                <span>${test.performance_metrics.translation_error_px.toFixed(1)}px</span>
                                <span>${test.alignment_result.execution_time_ms.toFixed(1)}ms</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function selectTest(testId) {
            selectedTest = selectedSession.test_results.find(t => t.test_id === testId);
            renderTestCases();
            showImageDisplay();
        }

        function showImageDisplay() {
            if (!selectedTest) return;

            const imageResults = document.getElementById('imageResults');
            
            imageResults.innerHTML = `
                <div class="image-container">
                    <h4>SEM Image with Alignment Overlay</h4>
                    <img src="/api/image/${selectedTest.visual_outputs.overlay_result_path}" 
                         alt="Alignment Overlay" 
                         onclick="openModal(this)"
                         onerror="this.style.display='none'">
                </div>
                <div class="image-container">
                    <h4>Original Patch</h4>
                    <img src="/api/image/${selectedTest.patch_info.patch_path}" 
                         alt="Original Patch" 
                         onclick="openModal(this)"
                         onerror="this.style.display='none'">
                </div>
                <div class="image-container">
                    <h4>Transformed Patch</h4>
                    <img src="/api/image/${selectedTest.transformation_applied.transformed_patch_path}" 
                         alt="Transformed Patch" 
                         onclick="openModal(this)"
                         onerror="this.style.display='none'">
                </div>
                <div class="metrics-panel">
                    <div class="metric-row">
                        <span class="metric-label">Algorithm</span>
                        <span class="metric-value">${selectedTest.algorithm_name}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Translation Error</span>
                        <span class="metric-value">${selectedTest.performance_metrics.translation_error_px.toFixed(2)}px</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Rotation Error</span>
                        <span class="metric-value">${selectedTest.performance_metrics.rotation_error_deg.toFixed(2)}°</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Confidence</span>
                        <span class="metric-value">${selectedTest.alignment_result.confidence.toFixed(3)}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Processing Time</span>
                        <span class="metric-value">${selectedTest.alignment_result.execution_time_ms.toFixed(1)}ms</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Status</span>
                        <span class="metric-value ${selectedTest.performance_metrics.success ? 'text-success' : 'text-error'}">
                            ${selectedTest.performance_metrics.success ? 'Success' : 'Failed'}
                        </span>
                    </div>
                </div>
            `;
        }

        function clearImageDisplay() {
            const imageResults = document.getElementById('imageResults');
            imageResults.innerHTML = '<div class="empty-state">Select a test case to view visual results</div>';
        }

        function renderAlgorithmSummary(summaries) {
            const summaryContainer = document.getElementById('algorithmSummary');
            
            if (!summaries.length) {
                summaryContainer.innerHTML = '<div class="empty-state">No algorithm data available</div>';
                return;
            }

            // Sort by success rate descending
            summaries.sort((a, b) => b.success_rate - a.success_rate);

            summaryContainer.innerHTML = summaries.map(summary => `
                <div class="algorithm-card">
                    <h4 class="algorithm-name">${summary.name}</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${summary.success_rate}%"></div>
                    </div>
                    <div class="algorithm-stats">
                        <div>
                            <span class="metric-label">Success Rate</span>
                            <strong>${summary.success_rate.toFixed(1)}%</strong>
                        </div>
                        <div>
                            <span class="metric-label">Total Tests</span>
                            <strong>${summary.total_tests}</strong>
                        </div>
                        <div>
                            <span class="metric-label">Avg Error</span>
                            <strong>${summary.avg_translation_error.toFixed(1)}px</strong>
                        </div>
                        <div>
                            <span class="metric-label">Avg Time</span>
                            <strong>${summary.avg_processing_time.toFixed(1)}ms</strong>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function applyFilters() {
            const params = new URLSearchParams();
            if (currentFilters.algorithm) params.append('algorithm', currentFilters.algorithm);
            if (currentFilters.patchSize) params.append('patch_size', currentFilters.patchSize);
            if (currentFilters.transformation) params.append('transformation', currentFilters.transformation);
            if (currentFilters.successOnly) params.append('success_only', 'true');

            try {
                const response = await fetch(`/api/data?${params}`);
                if (!response.ok) throw new Error('Failed to fetch filtered data');
                
                filteredData = await response.json();
                
                // Check if selected session still exists in filtered data
                if (selectedSession) {
                    const updatedSession = filteredData.test_sessions.find(s => s.id === selectedSession.id);
                    if (updatedSession && updatedSession.test_results.length > 0) {
                        selectedSession = updatedSession;
                        if (selectedTest) {
                            const testStillExists = updatedSession.test_results.find(t => t.test_id === selectedTest.test_id);
                            if (!testStillExists) {
                                selectedTest = null;
                                clearImageDisplay();
                            }
                        }
                    } else {
                        selectedSession = null;
                        selectedTest = null;
                        clearImageDisplay();
                    }
                }
                
                updateDashboard();
                if (selectedSession) {
                    renderTestCases();
                }
            } catch (error) {
                console.error('Error applying filters:', error);
                showToast('Failed to apply filters', 'error');
            }
        }

        function updateFilterStatus() {
            const hasActiveFilters = currentFilters.algorithm || 
                                   currentFilters.patchSize || 
                                   currentFilters.transformation || 
                                   currentFilters.successOnly;
            
            const filterStatus = document.getElementById('filterStatus');
            filterStatus.textContent = hasActiveFilters ? 'Active' : '';
        }

        function clearFilters() {
            currentFilters = {
                algorithm: '',
                patchSize: '',
                transformation: '',
                successOnly: false
            };
            
            document.getElementById('algorithmFilter').value = '';
            document.getElementById('patchSizeFilter').value = '';
            document.getElementById('transformationFilter').value = '';
            document.getElementById('successOnlyFilter').checked = false;
            
            applyFilters();
        }

        async function refreshData() {
            try {
                const response = await fetch('/api/refresh');
                if (!response.ok) throw new Error('Failed to refresh data');
                
                await loadDashboardData();
                showToast('Data refreshed successfully', 'success');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showToast('Failed to refresh data', 'error');
            }
        }

        // Modal functionality
        function openModal(img) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.onclick = closeModal;
            
            const modalImg = img.cloneNode();
            modalImg.style.cssText = '';
            modal.appendChild(modalImg);
            
            document.body.appendChild(modal);
        }

        function closeModal() {
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>